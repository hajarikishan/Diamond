@page "/shapes"
@rendermode InteractiveServer

@using Diamond.Share.Models
@inject HttpClient Http
@inject IJSRuntime JS

<h3 class="mb-4">Shapes</h3>

<div class="row">
    <!-- Left side: Table -->
    <div class="col-md-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <strong>Shapes List</strong>
            </div>
            <div class="card-body">
                <!-- Search -->
                <div class="input-group mb-3" style="max-width: 450px;">
                    <input type="text" class="form-control" placeholder="Search shapes by name..."
                           @bind="searchTerm" />
                    <button class="btn btn-primary" type="button" @onclick="ApplyFilters">
                        <i class="bi bi-search"></i> Search
                    </button>
                    <button class="btn btn-secondary ms-2" type="button" @onclick="ResetSearch">
                        <i class="bi bi-x-circle"></i> Reset
                    </button>
                </div>

                <!-- Table with Scroll -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Min Carat</th>
                                <th>Max Carat</th>
                                <th style="width:150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (pagedShapes.Any())
                            {
                                @foreach (var s in pagedShapes)
                                {
                                    <tr>
                                        <td>@s.ShapeId</td>
                                        <td>@s.ShapeName</td>
                                        <td>@s.Description</td>
                                        <td>@s.MinCarat</td>
                                        <td>@s.MaxCarat</td>
                                        <td>
                                            <button class="btn btn-sm btn-warning me-1" @onclick="() => EditShape(s)">Edit</button>
                                            <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(s.ShapeId)">Delete</button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No records found</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination Footer -->
            <div class="card-footer d-flex justify-content-between align-items-center">
                <div>
                    <label class="me-2">Rows per page:</label>
                    <select class="form-select form-select-sm d-inline w-auto" @bind="pageSize">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                    </select>
                </div>

                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" @onclick="PrevPage" disabled="@(!CanPrev)">Prev</button>
                    <span>Page @currentPage of @totalPages</span>
                    <button class="btn btn-outline-secondary btn-sm ms-2" @onclick="NextPage" disabled="@(!CanNext)">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right side: Add/Edit Form -->
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <strong>@(newShape.ShapeId == 0 ? "Add New Shape" : "Edit Shape")</strong>
            </div>
            <div class="card-body">
                <EditForm Model="newShape" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label class="form-label">Shape Name <span class="text-danger">*</span></label>
                        <InputText @bind-Value="newShape.ShapeName" class="form-control py-2" />
                        <ValidationMessage For="@(() => newShape.ShapeName)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <InputText @bind-Value="newShape.Description" class="form-control py-2" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Min Carat</label>
                        <InputNumber @bind-Value="newShape.MinCarat" class="form-control py-2" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Max Carat</label>
                        <InputNumber @bind-Value="newShape.MaxCarat" class="form-control py-2" />
                    </div>

                    <button type="submit" class="btn btn-success me-2 px-3 py-2">Save</button>
                    <button type="button" class="btn btn-secondary px-3 py-2" @onclick="Cancel">
                        @(newShape.ShapeId == 0 ? "Cancel" : "Back")
                    </button>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private readonly string baseUrl = "http://localhost:5218/api/shapes";

    private List<MD_SHAPE>? shapes;
    private List<MD_SHAPE> pagedShapes = new();
    private MD_SHAPE newShape = new() { Description = "", MinCarat = 0, MaxCarat = 0 };
    private string searchTerm = "";

    // Pagination
    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadShapes();
    }

    private async Task LoadShapes()
    {
        shapes = await Http.GetFromJsonAsync<List<MD_SHAPE>>(baseUrl);
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (shapes == null) return;

        var filtered = shapes
            .Where(s => string.IsNullOrEmpty(searchTerm) ||
                        s.ShapeName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            .ToList();

        totalPages = (int)Math.Ceiling(filtered.Count / (double)pageSize);
        if (currentPage > totalPages) currentPage = totalPages == 0 ? 1 : totalPages;

        pagedShapes = filtered.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
    }

    private void ResetSearch()
    {
        searchTerm = "";
        ApplyFilters();
    }

    private void PrevPage()
    {
        if (CanPrev) { currentPage--; ApplyFilters(); }
    }

    private void NextPage()
    {
        if (CanNext) { currentPage++; ApplyFilters(); }
    }

    private bool CanPrev => currentPage > 1;
    private bool CanNext => currentPage < totalPages;

    private async Task HandleValidSubmit()
    {
        await SaveShape();
    }

    private async Task SaveShape()
    {
        HttpResponseMessage response;

        if (string.IsNullOrWhiteSpace(newShape.ShapeName))
            return;

        if (newShape.ShapeId == 0)
            response = await Http.PostAsJsonAsync(baseUrl, newShape);
        else
            response = await Http.PutAsJsonAsync($"{baseUrl}/{newShape.ShapeId}", newShape);

        if (response.IsSuccessStatusCode)
        {
            await LoadShapes();
            newShape = new MD_SHAPE() { Description = "", MinCarat = 0, MaxCarat = 0 };
        }
    }

    private void EditShape(MD_SHAPE shape)
    {
        newShape = new MD_SHAPE
        {
            ShapeId = shape.ShapeId,
            ShapeName = shape.ShapeName,
            Description = shape.Description ?? "",
            MinCarat = shape.MinCarat,
            MaxCarat = shape.MaxCarat
        };
    }

    private async Task ConfirmDelete(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this shape?");
        if (confirmed) await DeleteShape(id);
    }

    private async Task DeleteShape(int id)
    {
        var response = await Http.DeleteAsync($"{baseUrl}/{id}");
        if (response.IsSuccessStatusCode)
        {
            await LoadShapes();
        }
    }

    private void Cancel()
    {
        newShape = new MD_SHAPE() { Description = "", MinCarat = 0, MaxCarat = 0 };
    }
}
